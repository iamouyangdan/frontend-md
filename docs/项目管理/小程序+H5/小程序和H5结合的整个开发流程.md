# 小程序和H5结合的整个开发流程
小程序：survey-uniapp

H5：linkkap-diagnosis-h5

# 1. 代码克隆和运行

- 在云效上克隆代码，没有权限找欧阳丹开权限

![](https://tcs-devops.aliyuncs.com/storage/112f4e16d08b962d0ec062f96551d4f847e0?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY0ZTE2ZDA4Yjk2MmQwZWMwNjJmOTY1NTFkNGY4NDdlMCJ9.ZzK3uKp6zkp_YlK8zOcOQejdHkWt21gZJrAW518XU9w&download=image.png "")

两个项目的代码仓库地址如下：

git@codeup.aliyun.com:5f009f6e6a575d7f23661045/linkkap/linkkap-diagnosis-h5.git

git@codeup.aliyun.com:5f009f6e6a575d7f23661045/questionnaire/frontend/survey-uniapp.git

- 在所在文件夹，运行终端，输入命令克隆代码，命令：git clone 代码仓库地址。

![](https://tcs-devops.aliyuncs.com/storage/112ffbbceab731aa4e72c78450c731490cfd?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmZmYmJjZWFiNzMxYWE0ZTcyYzc4NDUwYzczMTQ5MGNmZCJ9.8zCwSQg1iBw4WCTCrXrzvvgPihBqtl-oPaW0NmhZtrY&download=image.png "")

- 在vscode打开项目文件，首先查看READMD.md文件，浏览大概的文件目录结构。

- 安装包管理器npm.  命令：npm install或者npm i

![](https://tcs-devops.aliyuncs.com/storage/112fb80414fbbd4692feb26a47bd63e1be18?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmZiODA0MTRmYmJkNDY5MmZlYjI2YTQ3YmQ2M2UxYmUxOCJ9.al4HYlV4Hm1YqccvIIhEgChN_FgixhbYkp7t1W0Cp-c&download=image.png "")

- 查看代码仓库的分支命令：git branch。切换分支命令：git checkout 分支名。

![](https://tcs-devops.aliyuncs.com/storage/112f43d3218bfac2230c8f015a841072c1c9?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY0M2QzMjE4YmZhYzIyMzBjOGYwMTVhODQxMDcyYzFjOSJ9.25NGT2v9Gg1OXGfOYJTK2vOkquf-XGSQ-DWQ8PbL4SM&download=image.png "")

- 小程序是基于uniapp框架，在vscode环境运行，运行命令为npm run dev:mp-weixin，在package.json文件可看到所有的脚本命令。dev字符代表开发环境，mp-weiixn代表为微信平台，最后会打包一个dev的文件夹，所在目录是dist\dev\mp-weixin。

![](https://tcs-devops.aliyuncs.com/storage/112f72b514f638c95d84306f790663c60aa0?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY3MmI1MTRmNjM4Yzk1ZDg0MzA2Zjc5MDY2M2M2MGFhMCJ9.V0Yati0nPzZlFJNCSPcvD7mmzszw82dGn9ux9gVComI&download=image.png "")

![](https://tcs-devops.aliyuncs.com/storage/112f63b51d285d77fd809a0eaff863a15e4b?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY2M2I1MWQyODVkNzdmZDgwOWEwZWFmZjg2M2ExNWU0YiJ9.lA5xsIei8InrCRh9Wo2f-7pA2JY8J3koI90YEoduaHw&download=image.png "")

- 在微信开发者工具运行，新建小程序项目，填写项目名称、目录为上图打包的mp-weixin文件夹导入，AppID找负责人拿，确认即可创建小程序。可以实现在vscode编写代码，可以在微信开发者工具实时编译同步开发。

AppID：wxf04d381e67efdd3f

![](https://tcs-devops.aliyuncs.com/storage/112f526fc29a817320288cc8912a6f03d294?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY1MjZmYzI5YTgxNzMyMDI4OGNjODkxMmE2ZjAzZDI5NCJ9.iDhtQ04eQOjuGJp4j73Xb57jwc4FZOwEPPvLpTHI4Qc&download=image.png "")

- H5是基于vue框架，是一个多页面应用。在vscode打开上面克隆下来的文件夹。新建终端运行命令，新建终端的快捷键：ctrl+shift+、,关闭终端：ctrl+J。安装包管理器npm和查看切换git分支与上面的操作一致。

- 在package.json文件查看运行的脚本命令，开发环境运行命令npm run dev。

![](https://tcs-devops.aliyuncs.com/storage/112fb92f6ec4a88448944239bf5509dcec26?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmZiOTJmNmVjNGE4ODQ0ODk0NDIzOWJmNTUwOWRjZWMyNiJ9.YXYshGrPuYqtR1UESefPEF9WS8rgPdbbR-bVYWdl6ng&download=image.png "")

# 2.H5页面的创建

因为这个H5页面是多页面应用，所以创建页面相比单页面应用不一样，创建页面步骤如下：

- 在src/html文件夹下创建一个html文件，incentiveReport.html。

- 在script/entry文件夹下创建一个 incentiveReport 文件夹，里面有index.js和index.json。

- 在script/view 文件夹下创建一个 incentiveReport 文件夹 里面放incentiveRepor.vue文件，实际页面代码。

-  创建好后再启动项目：命令：npm run dev

单页面应用，可以上网查如何创建页面。



# 3.小程序中嵌入H5页面

在这次的项目中，实现在小程序和H5的跳转和交互。



### survey-uniapp：

- 在小程序中嵌入H5页面，需要使用到一个web-view的组件，用来承载网页的容器，会自动铺满整个小程序页面。在微信官方文档可以查到。

```text
<template>
  <div>
    <web-view :src="reportUrl" />
  </div>
</template>
```

- 主要是实现小程序跳转到H5，要配置跳转的网页链接src。

```text
this.reportUrl = `${process.env.VUE_APP_H5_DOMAIN}/${path}/index.html?${paramsStr}`
```

- 小程序获取H5页面传来的参数：web-view组件中的bindmessage属性是向H5向小程序传值。

```text
H5中：
wx.miniProgram.postMessage({
  //这里一定要将数据放在dada中
  data: {
    message: msg
  }
});
//H5向小程序传值的方法会在特定的时间触发，因此需要我们手动写一个跳转（也可以写后退和摧毁，分享，以需求而定）
wx.miniProgram.redirectTo({
  url: '../pay/wxpay' //这里是小程序页面
})
```

```text
小程序中：
wxml
<web-view src="{{link}}" bindmessage="handlePostMessage"></web-view>

wxjs
Page({
  data: {
    url: 'url: 'https://www.baidu.com' //这里是H5的地址
  }，
  onLoad: function (options) {},
  // 接收 h5 页面传递过来的参数
  handlePostMessage: function (e) {
    let resObj = e.detail.data[e.detail.data.length - 1];
//多次传递会是数组的形式，传递一次会push进数组，所以我们需要拿到最新的数据，也就是数组的最后一个子集
    console.log(resObj.message)
  }
})
```

小程序之间的页面传参：生命周期onLoad(args)函数可以获取到页面间传过来的参数args。

### linkkap-diagnosis-h5：

从H5跳转到小程序，要引入微信的js接口文件，使用微信的Api。[web-view](https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html)网页中可使用[JSSDK 1.3.2](https://res.wx.qq.com/open/js/jweixin-1.3.2.js)提供的接口返回小程序页面

```text
// <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>

// javascript
wx.miniProgram.navigateTo({url: '/path/to/page'})
wx.miniProgram.postMessage({ data: 'foo' })
wx.miniProgram.postMessage({ data: {foo: 'bar'} })
wx.miniProgram.getEnv(function(res) { console.log(res.miniprogram) })
```

返回小程序页面的接口有wx.miniProgram.navigateTo、wx.miniProgram.redirectTo等。

```text
wx.miniProgram.navigateTo({url: `/pages/report/pay?money=${this.paymentInfo.price}&desc=${this.paymentInfo.reportFullName}&code=${this.paymentInfo.code}`})
```

H5页面获取小程序传来的参数：

```text
const getUrlQuery = (name) => {
  var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i')
  var r = window.location.search.substr(1).match(reg)
  if (r == null) return ''
  const res = decodeURIComponent(r[2])
  if (res === 'undefined' || res === 'null') return ''
  return res
}

// this.appId = getUrlQuery('appId')
```

# 4.小程序的调试、预览和改bug

### 页面调试：

- 在pages.json文件添加相应页面的路径。

- 添加编译模式，填写对应的路径和所需要的参数

![](https://tcs-devops.aliyuncs.com/storage/112fa23d77391e3a3de52cbc9920e9ee6582?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmZhMjNkNzczOTFlM2EzZGU1MmNiYzk5MjBlOWVlNjU4MiJ9.45f93R1fbkBrwVlRZlLaPjUnQoxCkhxS87Ujw9iorkk&download=image.png "")

![](https://tcs-devops.aliyuncs.com/storage/112f9389502098d18edef7ad0f33bcfc6085?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY5Mzg5NTAyMDk4ZDE4ZWRlZjdhZDBmMzNiY2ZjNjA4NSJ9.lYuC-smLI1xRksZXCQdpzGuNb3rcyqTAwBH-TpeVmHI&download=image.png "")

在console面板，查看报错原因。

- 或者是根据开发环境下方的页面路径，快速定位找到该页面出现的bug

![](https://tcs-devops.aliyuncs.com/storage/112f7fc4d71753ee636abe1d1cba2dfe1aa4?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY3ZmM0ZDcxNzUzZWU2MzZhYmUxZDFjYmEyZGZlMWFhNCJ9.shmzmLnyttOatxkIiywwQ4mVzPY9I3jijulj5B0dzyk&download=image.png "")

### 预览和真机调试：

可以预览在不同平台上样式是否有差异和测试小程序，找到bug所在位置。在真机上，如果想要查看 `console` API 输出的日志内容和额外的调试信息，需要在点击屏幕右上角的按钮打开的菜单里选择「打开调试」。此时小程序退出，重新打开后右下角会出现一个 `vConsole` 按钮。点击 `vConsole` 按钮可以打开日志面板。

# 5.小程序的打包和上传（开发环境和生产环境）

小程序的体验版和正式版本

![](https://tcs-devops.aliyuncs.com/storage/112f404189a1781878517e7ccdb6ade56880?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY0MDQxODlhMTc4MTg3ODUxN2U3Y2NkYjZhZGU1Njg4MCJ9.of80FqnsrM43pUD5HlO31zBXt4v-ul_deIpgS_Gpl5Y&download=image.png "")

### 开发环境：(体验版)

- 在VScode运行命令：npm run dev:bulid:mp-weixin。最后在打包的文件夹dist里面有dev的文件夹。

![](https://tcs-devops.aliyuncs.com/storage/112f797f43a786b093bcc8878def2b09f712?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY3OTdmNDNhNzg2YjA5M2JjYzg4NzhkZWYyYjA5ZjcxMiJ9.g2QJMW7gsizGhLNdoq3hSQU1bq5oJYwuRfSCxC5h4DU&download=image.png "")

- 在微信开发者工具打开上图中mp-weixin文件夹。点击上传，提示窗口中输入版本号和说明即可

![](https://tcs-devops.aliyuncs.com/storage/112f9788adb5ac784628217ab55e7b299953?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY5Nzg4YWRiNWFjNzg0NjI4MjE3YWI1NWU3YjI5OTk1MyJ9.7didbYgaf7GYaIS_HwYv_Qn5_OC6419HsmMWmAR75QE&download=image.png "")

- 上传完毕后，登录微信公众号后台，点击左侧菜单的版本管理，把刚上传的版本选为体验版本即可。

![](https://tcs-devops.aliyuncs.com/storage/112f917eb9687c36754513d5fb3447c2c98d?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY5MTdlYjk2ODdjMzY3NTQ1MTNkNWZiMzQ0N2MyYzk4ZCJ9._TFmzepXX27l2h9zygF0zRQbLHz73Ap3bRXPT25Fzck&download=image.png "")

### 生产环境：（正式版本-提交代码审核）

- 在vscode运行命令：prod:build:mp-weixi，最后打包一个bulid的文件夹

![](https://tcs-devops.aliyuncs.com/storage/112f9d7191ea19346248781ab7e0397ce943?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmY5ZDcxOTFlYTE5MzQ2MjQ4NzgxYWI3ZTAzOTdjZTk0MyJ9.KIJcmTF4qP56uWVuSlxvFse09aUuS3wN-JBTTXrjQCo&download=image.png "")



- 在微信开发者工具打开上图的mp-weixin文件夹。点击上传即可。

- 上传完毕后，登录微信公众号后台，点击左侧菜单的版本管理，把刚上传的版本提交审核，

- 按提示填写相关资料即可。

# 6.代码的更新和提交

- 每天上班前要更新代码，每天下班前要提交代码

- 代码更新命令：git pull

- 提交代码步骤：最后的命令: git push

![](https://tcs-devops.aliyuncs.com/storage/112fe5ef8826ec0fcd3d268bca8a3c3a858e?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY1MjUwMTY5NiwiaWF0IjoxNjUxODk2ODk2LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMmZlNWVmODgyNmVjMGZjZDNkMjY4YmNhOGEzYzNhODU4ZSJ9.pW0zycTnf7Wg3n-OoD5FvLxqqr5ZXLC0WqxK3orIA_o&download=image.png "")

- git stash和git stash pop：git stash 可用来暂存当前正在进行的工作， 比如想pull 最新代码， 又不想加新commit， 或者另外一种情况，为了fix 一个紧急的bug,  先stash, 使返回到自己上一个commit, 改完bug之后再stash pop, 继续原来的工作。

